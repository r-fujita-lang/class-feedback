<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ»AIé›†è¨ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">
    <div class="max-w-md mx-auto p-4">
        
        <!-- ç®¡ç†ç”¨ã‚¿ãƒ– -->
        <div id="tabContainer" class="flex border-b border-slate-200 mb-6 bg-white rounded-t-xl shadow-sm overflow-hidden">
            <button onclick="switchTab('user')" id="tab-user" class="tab-btn active relative flex-1 py-4 font-bold text-blue-600 text-sm">å›ç­”ã™ã‚‹</button>
            <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn relative flex-1 py-4 font-bold text-slate-500 text-sm">ç®¡ç†ç”»é¢</button>
        </div>

        <!-- ã€å›ç­”ç”»é¢ã€‘ -->
        <div id="view-user" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 mb-6 text-center text-blue-700">æˆæ¥­ã®æŒ¯ã‚Šè¿”ã‚Š</h2>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectRating(3)" id="rate-3" class="p-4 rounded-xl border-2 border-transparent bg-slate-50 hover:bg-blue-50 transition-all">
                        <div class="text-3xl mb-1">ğŸ˜Š</div>
                        <div class="text-[10px] font-bold">ãƒãƒƒãƒãƒª</div>
                    </button>
                    <button onclick="selectRating(2)" id="rate-2" class="p-4 rounded-xl border-2 border-transparent bg-slate-50 hover:bg-blue-50 transition-all">
                        <div class="text-3xl mb-1">ğŸ˜</div>
                        <div class="text-[10px] font-bold">ã¾ã‚ã¾ã‚</div>
                    </button>
                    <button onclick="selectRating(1)" id="rate-1" class="p-4 rounded-xl border-2 border-transparent bg-slate-50 hover:bg-blue-50 transition-all">
                        <div class="text-3xl mb-1">ğŸ˜•</div>
                        <div class="text-[10px] font-bold">ä¸å®‰</div>
                    </button>
                </div>
                <textarea id="userComment" placeholder="ã‚ã‹ã£ãŸã“ã¨ã€é›£ã—ã‹ã£ãŸã“ã¨ã‚’æ›¸ã„ã¦ã­" class="w-full h-32 bg-slate-50 border rounded-xl p-4 text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                <button onclick="submitResponse()" class="w-full mt-6 bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>

        <!-- ã€ç®¡ç†ç”»é¢ã€‘ -->
        <div id="view-admin" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center">
                <div>
                    <h3 class="text-xs text-slate-500 font-bold tracking-tight">å›ç­”æ•°</h3>
                    <p id="stat-total" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <button onclick="showQrModal()" class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-xl hover:bg-slate-100 active:scale-95 transition-all">ğŸ“±</button>
            </div>

            <!-- AIé€£æºã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã‚’ä¿®æ­£ï¼‰ -->
            <div class="bg-indigo-600 p-5 rounded-2xl shadow-lg text-white">
                <h3 class="font-bold flex items-center gap-2 text-sm mb-3">âœ¨ AIåˆ†æç”¨ã«ã‚³ãƒ”ãƒ¼</h3>
                <p class="text-[10px] mb-4 opacity-80 leading-relaxed">
                    å›ç­”å†…å®¹ã‚’åˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä¸€ç·’ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚<br>ChatGPTãªã©ã®AIã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
                </p>
                <button onclick="copyForAIOnly()" class="w-full bg-white text-indigo-700 font-bold py-3 rounded-xl text-xs hover:bg-indigo-50 active:scale-95 transition-all shadow-sm">
                    å›ç­”ã‚’AIè²¼ã‚Šä»˜ã‘ç”¨ã«ã‚³ãƒ”ãƒ¼
                </button>
            </div>

            <!-- ã‚°ãƒ©ãƒ• -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="h-44"><canvas id="scoreChart"></canvas></div>
            </div>

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
            <div class="flex justify-between items-center px-1">
                <h3 class="text-sm font-bold text-slate-700">ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
                <button onclick="clearData()" class="text-[10px] text-red-400 font-bold hover:underline">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div id="commentList" class="space-y-3"></div>
        </div>

        <!-- QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="qrModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 hidden">
            <div class="bg-white rounded-3xl p-8 max-w-xs w-full text-center relative shadow-2xl">
                <button onclick="hideQrModal()" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500">âœ•</button>
                <div id="qrcode" class="flex justify-center mb-6 p-2 bg-white border border-slate-100 rounded-2xl"></div>
                <p class="text-[11px] text-slate-500 font-bold mb-4">ç”Ÿå¾’ã¯ã“ã®QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
                <button onclick="copyStudentUrl()" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100 transition-colors flex items-center justify-center gap-2 border border-blue-100 active:scale-95 transition-all">
                    <span>ğŸ”— ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼</span>
                </button>
            </div>
        </div>

        <!-- é€šçŸ¥ -->
        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-xs shadow-xl opacity-0 transition-all pointer-events-none z-[100]"></div>
    </div>

    <script>
        let selectedRate = 0;
        let chartInstance = null;
        let responses = JSON.parse(localStorage.getItem('class_feedback_v3') || '[]');

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'user') {
                document.getElementById('tabContainer').style.display = 'none';
                switchTab('user');
            }
            refreshAdminUI();
        };

        function switchTab(tab) {
            document.getElementById('view-user').classList.toggle('hidden', tab !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-user').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'user' ? 'active text-blue-600' : 'text-slate-500'}`;
            document.getElementById('tab-admin').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'admin' ? 'active text-blue-600' : 'text-slate-500'}`;
            if (tab === 'admin') updateChart();
        }

        function selectRating(val) {
            selectedRate = val;
            [1, 2, 3].forEach(v => {
                const btn = document.getElementById(`rate-${v}`);
                btn.style.borderColor = v === val ? '#3b82f6' : 'transparent';
                btn.style.backgroundColor = v === val ? '#eff6ff' : '#f8fafc';
            });
        }

        function submitResponse() {
            const comment = document.getElementById('userComment').value.trim();
            if (selectedRate === 0) return showMsg("è©•ä¾¡ã‚’é¸ã‚“ã§ã­");
            const now = new Date();
            responses.push({ 
                rate: selectedRate, 
                comment: comment || "ç„¡è¨˜å…¥", 
                time: `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`, 
                ts: now.getTime() 
            });
            localStorage.setItem('class_feedback_v3', JSON.stringify(responses));
            document.getElementById('userComment').value = '';
            showMsg("é€ä¿¡ã—ã¾ã—ãŸï¼");
            refreshAdminUI();
        }

        function refreshAdminUI() {
            document.getElementById('stat-total').textContent = responses.length;
            const list = document.getElementById('commentList');
            const sorted = [...responses].sort((a, b) => b.ts - a.ts);
            list.innerHTML = sorted.map(r => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex gap-3 items-start">
                    <span class="text-xl">${r.rate===3?'ğŸ˜Š':r.rate===2?'ğŸ˜':'ğŸ˜•'}</span>
                    <div class="flex-1">
                        <div class="text-[9px] text-slate-400 font-bold mb-1">${r.time}</div>
                        <p class="text-xs text-slate-600 font-medium">${r.comment}</p>
                    </div>
                </div>
            `).join('');
            if (document.getElementById('view-admin').className.indexOf('hidden') === -1) updateChart();
        }

        function updateChart() {
            const canvas = document.getElementById('scoreChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const counts = [0, 0, 0];
            responses.forEach(r => counts[r.rate - 1]++);
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š'],
                    datasets: [{ data: counts, backgroundColor: ['#f87171', '#fbbf24', '#34d399'], borderRadius: 6 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        // ä¿®æ­£ï¼šã‚³ãƒ”ãƒ¼ã®ã¿ã‚’è¡Œã„ã€å¤–éƒ¨ã‚µã‚¤ãƒˆã¯é–‹ã‹ãªã„
        function copyForAIOnly() {
            if (responses.length === 0) return showMsg("å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const text = responses.map(r => `ã€è©•ä¾¡:${r.rate}ã€‘${r.comment}`).join('\n');
            const prompt = `ä»¥ä¸‹ã®æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€1.å…¨ä½“ã®å‚¾å‘ã€2.ã¤ã¾ãšããƒã‚¤ãƒ³ãƒˆã€3.æ¬¡å›ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚\n\n${text}`;
            copyToClipboard(prompt, "AIç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }

        function copyStudentUrl() {
            const currentUrl = window.location.origin + window.location.pathname;
            const studentUrl = currentUrl + "?mode=user";
            copyToClipboard(studentUrl, "ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }

        function copyToClipboard(text, msg) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showMsg(msg);
        }

        function clearData() { if (confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { responses = []; localStorage.removeItem('class_feedback_v3'); refreshAdminUI(); showMsg("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"); } }
        
        function showQrModal() {
            const currentUrl = window.location.origin + window.location.pathname;
            const studentUrl = currentUrl + "?mode=user";
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: studentUrl, width: 180, height: 180 });
            document.getElementById('qrModal').classList.remove('hidden');
        }
        
        function hideQrModal() { document.getElementById('qrModal').classList.add('hidden'); }
        function showMsg(m) { 
            const t = document.getElementById('toast'); 
            t.textContent = m; t.style.opacity = "1"; 
            setTimeout(() => t.style.opacity = "0", 2500); 
        }
    </script>
</body>
</html>


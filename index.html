<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ»AIé›†è¨ˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .rating-card { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; }
        .rating-card.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: #3b82f6; }
        .ai-loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-2xl mx-auto p-4 md:p-8">
        
        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆç”Ÿå¾’ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼‰ -->
        <div id="tabContainer" class="flex border-b border-slate-200 mb-8 bg-white rounded-t-xl shadow-sm overflow-hidden">
            <button onclick="switchTab('user')" id="tab-user" class="tab-btn active relative flex-1 py-4 font-bold text-blue-600">å›ç­”ã™ã‚‹</button>
            <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn relative flex-1 py-4 font-bold text-slate-500">ç®¡ç†ç”»é¢</button>
        </div>

        <!-- ã€å›ç­”è€…ç”¨ç”»é¢ã€‘ -->
        <div id="view-user" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">ä»Šæ—¥ã®å­¦ç¿’ã®æŒ¯ã‚Šè¿”ã‚Š</h2>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div onclick="selectRating(3)" id="rate-3" class="rating-card bg-slate-50 p-4 rounded-xl text-center">
                        <div class="text-4xl mb-2">ğŸ˜Š</div>
                        <div class="text-sm font-bold">ãƒãƒƒãƒãƒªï¼</div>
                    </div>
                    <div onclick="selectRating(2)" id="rate-2" class="rating-card bg-slate-50 p-4 rounded-xl text-center">
                        <div class="text-4xl mb-2">ğŸ˜</div>
                        <div class="text-sm font-bold">ã¾ã‚ã¾ã‚</div>
                    </div>
                    <div onclick="selectRating(1)" id="rate-1" class="rating-card bg-slate-50 p-4 rounded-xl text-center">
                        <div class="text-4xl mb-2">ğŸ˜•</div>
                        <div class="text-sm font-bold">ã¡ã‚‡ã£ã¨ä¸å®‰</div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600">å…·ä½“çš„ã«ã‚ˆã‹ã£ãŸã¨ã“ã‚ã‚„ã€è³ªå•ã‚’æ›¸ã„ã¦ã­</label>
                    <textarea id="userComment" placeholder="ä¾‹ï¼šä¸‰è§’å½¢ã®é¢ç©ã®å‡ºã—æ–¹ãŒã‚ã‹ã£ãŸã€‚å…¬å¼ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ãŸã„ã€‚" 
                        class="w-full h-32 bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none"></textarea>
                </div>

                <button onclick="submitResponse()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                    å…ˆç”Ÿã«é€ã‚‹
                </button>
            </div>
        </div>

        <!-- ã€ç®¡ç†è€…ç”¨ç”»é¢ã€‘ -->
        <div id="view-admin" class="hidden space-y-6">
            <div id="admin-content" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                        <h3 class="text-xs text-slate-500">å›ç­”æ•°</h3>
                        <p id="stat-total" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <button onclick="showQrModal()" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center hover:bg-slate-50 transition-colors">
                        <span class="text-2xl">ğŸ“±</span>
                        <p class="text-xs font-bold text-slate-600 mt-1">ç”Ÿå¾’ç”¨QRã‚’è¡¨ç¤º</p>
                    </button>
                </div>

                <!-- AIåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-xl text-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold">âœ¨ æœ¬æ ¼AIåˆ†æ (Gemini)</h3>
                        <button onclick="runRealAiAnalysis()" id="aiBtn" class="bg-white text-indigo-700 px-4 py-1 rounded-full text-xs font-bold hover:bg-indigo-50 transition-all">
                            åˆ†æã‚’é–‹å§‹
                        </button>
                    </div>
                    <div id="ai-result" class="text-sm leading-relaxed bg-black/10 p-4 rounded-xl border border-white/10 min-h-[100px]">
                        ã€Œåˆ†æã‚’é–‹å§‹ã€ã‚’æŠ¼ã™ã¨ã€AIãŒç”Ÿå¾’ã®å£°ã‚’è¦ç´„ã—ã¾ã™ã€‚
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
                    <h3 class="font-bold mb-4 text-slate-700">ç†è§£åº¦ã®åˆ†å¸ƒ</h3>
                    <div class="h-40"><canvas id="scoreChart"></canvas></div>
                </div>

                <div id="commentList" class="space-y-3"></div>
            </div>
        </div>

        <!-- QRãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="qrModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative">
                <button onclick="hideQrModal()" class="absolute top-4 right-4 text-slate-400 p-2 text-xl">âœ•</button>
                <h3 class="text-xl font-bold text-slate-800 mb-2">å›ç­”ç”¨QRã‚³ãƒ¼ãƒ‰</h3>
                <p class="text-xs text-slate-400 mb-6 font-bold">â€»ç”Ÿå¾’ã¯ã“ã®QRã‹ã‚‰å›ç­”å°‚ç”¨ç”»é¢ãŒé–‹ãã¾ã™</p>
                <div id="qrcode" class="flex justify-center mb-6 border-4 border-slate-100 p-2 rounded-xl inline-block mx-auto"></div>
                <button onclick="copyStudentUrl()" class="text-blue-600 text-xs font-bold underline">ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4"></div>
    </div>

    <script>
        const apiKey = ""; 
        let responses = [];
        let selectedRate = 0;
        let chartInstance = null;
        let isUserMode = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'user') {
                isUserMode = true;
                document.getElementById('tabContainer').classList.add('hidden');
                switchTab('user');
            }
        };

        function switchTab(tab) {
            if (isUserMode && tab === 'admin') return; // ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç®¡ç†ç”»é¢ã¸è¡Œã‘ãªã„
            document.getElementById('view-user').classList.toggle('hidden', tab !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-user').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'user' ? 'active text-blue-600' : 'text-slate-500'}`;
            document.getElementById('tab-admin').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'admin' ? 'active text-blue-600' : 'text-slate-500'}`;
            if (tab === 'admin') refreshAdminData();
        }

        function selectRating(val) {
            selectedRate = val;
            [1, 2, 3].forEach(v => document.getElementById(`rate-${v}`).className = `rating-card bg-slate-50 p-4 rounded-xl text-center border-2 ${v === val ? 'border-blue-500 bg-blue-50' : 'border-transparent'}`);
        }

        function submitResponse() {
            const comment = document.getElementById('userComment').value.trim();
            if (selectedRate === 0) return showToast("ä»Šã®æ°—æŒã¡ã‚’é¸ã‚“ã§ã­");
            responses.push({ rate: selectedRate, comment: comment || "ç„¡è¨˜å…¥", time: new Date().toLocaleTimeString() });
            selectedRate = 0;
            document.getElementById('userComment').value = '';
            document.querySelectorAll('.rating-card').forEach(el => el.className = "rating-card bg-slate-50 p-4 rounded-xl text-center border-2 border-transparent");
            showToast("å…ˆç”Ÿã«é€ã£ãŸã‚ˆï¼ã‚ã‚ŠãŒã¨ã†ï¼");
        }

        function refreshAdminData() {
            document.getElementById('stat-total').textContent = responses.length;
            const list = document.getElementById('commentList');
            list.innerHTML = responses.map(r => `
                <div class="bg-white p-3 rounded-xl border border-slate-200 flex gap-3 text-sm">
                    <span class="text-xl">${r.rate===3?'ğŸ˜Š':r.rate===2?'ğŸ˜':'ğŸ˜•'}</span>
                    <div><p class="text-slate-700 font-medium">${r.comment}</p><p class="text-[10px] text-slate-400 mt-1">${r.time}</p></div>
                </div>
            `).reverse().join('');
            updateChart();
        }

        function updateChart() {
            const counts = [0, 0, 0];
            responses.forEach(r => counts[r.rate - 1]++);
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š'],
                    datasets: [{ data: counts, backgroundColor: ['#f87171', '#fbbf24', '#34d399'], borderRadius: 8 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        async function runRealAiAnalysis() {
            if (responses.length === 0) return showToast("å›ç­”ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“");
            const btn = document.getElementById('aiBtn');
            const resultDiv = document.getElementById('ai-result');
            btn.disabled = true;
            btn.textContent = "AIåˆ†æä¸­...";
            resultDiv.innerHTML = '<div class="ai-loading">å›ç­”ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

            const commentList = responses.map(r => `ã€è©•ä¾¡:${r.rate}ã€‘ ${r.comment}`).join('\n');
            const prompt = `ã‚ãªãŸã¯æ•™å¸«ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€1.å…¨ä½“ã®ãƒ ãƒ¼ãƒ‰ã€2.å…·ä½“çš„ã«ã¤ã¾ãšã„ã¦ã„ã‚‹ç‚¹ã€3.æ˜æ—¥ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç°¡æ½”ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚\n\n${commentList}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                resultDiv.innerHTML = (result.candidates?.[0]?.content?.parts?.[0]?.text || "åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚").replace(/\n/g, '<br>');
            } catch (e) { resultDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"; }
            btn.disabled = false;
            btn.textContent = "åˆ†æã‚’æ›´æ–°";
        }

        // ç”Ÿå¾’ç”¨ã®URLã‚’ç”Ÿæˆï¼ˆ?mode=userã‚’ä»˜åŠ ï¼‰
        function getStudentUrl() {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', 'user');
            return url.toString();
        }

        function showQrModal() {
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { 
                text: getStudentUrl(), 
                width: 200, 
                height: 200,
                correctLevel : QRCode.CorrectLevel.H
            });
            document.getElementById('qrModal').classList.remove('hidden');
        }

        function hideQrModal() { document.getElementById('qrModal').classList.add('hidden'); }

        function copyStudentUrl() {
            navigator.clipboard.writeText(getStudentUrl());
            showToast("ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-100 transform translate-y-0 z-[100]";
            setTimeout(() => t.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-0 transform translate-y-4", 3000);
        }
    </script>
</body>
</html>


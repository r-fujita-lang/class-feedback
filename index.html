<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ»AIåˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .rating-card { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; }
        .rating-card:active { transform: scale(0.95); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: #3b82f6; }
        .ai-glow { animation: glow 2s infinite ease-in-out; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); } 50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.8); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">
    <div class="max-w-md mx-auto p-4">
        
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div id="tabContainer" class="flex border-b border-slate-200 mb-6 bg-white rounded-t-xl shadow-sm overflow-hidden">
            <button onclick="switchTab('user')" id="tab-user" class="tab-btn active relative flex-1 py-4 font-bold text-blue-600 text-sm">å›ç­”ã™ã‚‹</button>
            <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn relative flex-1 py-4 font-bold text-slate-500 text-sm">ç®¡ç†ç”»é¢</button>
        </div>

        <!-- ã€1. å›ç­”ç”»é¢ã€‘ -->
        <div id="view-user" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 mb-6 text-center">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</h2>
                
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="selectRating(3)" id="rate-3" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm border-2">
                        <div class="text-3xl mb-1">ğŸ˜Š</div>
                        <div class="text-[10px] font-bold text-slate-600">ãƒãƒƒãƒãƒª</div>
                    </button>
                    <button onclick="selectRating(2)" id="rate-2" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm border-2">
                        <div class="text-3xl mb-1">ğŸ˜</div>
                        <div class="text-[10px] font-bold text-slate-600">ã¾ã‚ã¾ã‚</div>
                    </button>
                    <button onclick="selectRating(1)" id="rate-1" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm border-2">
                        <div class="text-3xl mb-1">ğŸ˜•</div>
                        <div class="text-[10px] font-bold text-slate-600">ä¸å®‰</div>
                    </button>
                </div>

                <div class="space-y-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase">æ„Ÿæƒ³ãƒ»è³ªå•</label>
                    <textarea id="userComment" placeholder="å­¦ã‚“ã ã“ã¨ã‚„ã€ã‚ã‹ã‚‰ãªã‹ã£ãŸã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ã­" 
                        class="w-full h-32 bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-all"></textarea>
                </div>

                <button onclick="submitResponse()" id="submitBtn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
                    é€ä¿¡ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- ã€2. ç®¡ç†ç”»é¢ã€‘ -->
        <div id="view-admin" class="hidden space-y-4">
            <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                    <h3 class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">åˆè¨ˆå›ç­”æ•°</h3>
                    <p id="stat-total" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <button onclick="showQrModal()" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center hover:bg-slate-50 transition-colors">
                    <span class="text-2xl">ğŸ“±</span>
                    <p class="text-[10px] font-bold text-slate-600 mt-1">ç”Ÿå¾’ç”¨QR</p>
                </button>
            </div>

            <!-- AIåˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 p-5 rounded-2xl shadow-lg text-white ai-glow">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold flex items-center gap-2 text-sm">
                        <span>âœ¨</span> Gemini AI åˆ†æ
                    </h3>
                    <button onclick="runAiAnalysis()" id="aiBtn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-full text-[10px] font-bold transition-all border border-white/30">
                        åˆ†æã‚’å®Ÿè¡Œ
                    </button>
                </div>
                <div id="ai-result" class="text-xs leading-relaxed bg-black/20 p-3 rounded-xl border border-white/10 min-h-[60px]">
                    å›ç­”ãŒãŸã¾ã‚‹ã¨AIãŒé›†è¨ˆçµæœã‚’è¦ç´„ã—ã¾ã™ã€‚
                </div>
            </div>

            <!-- ã‚°ãƒ©ãƒ• -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="h-44"><canvas id="scoreChart"></canvas></div>
            </div>

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <div class="flex justify-between items-center px-1 mt-6">
                <h3 class="text-sm font-bold text-slate-700">å›ç­”è©³ç´°ï¼ˆæ–°ã—ã„é †ï¼‰</h3>
                <button onclick="clearData()" class="text-[10px] text-red-400 font-bold hover:underline">å…¨æ¶ˆå»</button>
            </div>
            <div id="commentList" class="space-y-3"></div>
        </div>

        <!-- QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="qrModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 hidden">
            <div class="bg-white rounded-3xl p-8 max-w-xs w-full text-center relative shadow-2xl">
                <button onclick="hideQrModal()" class="absolute top-4 right-4 text-slate-300 text-xl font-light">âœ•</button>
                <div id="qrcode" class="flex justify-center mb-4 p-2 bg-white border border-slate-100 rounded-2xl"></div>
                <p class="text-[10px] text-slate-500 font-bold mb-4">ç”Ÿå¾’ã¯ã“ã®QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
                <button onclick="copyStudentUrl()" class="w-full py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200 transition-colors">URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm shadow-2xl opacity-0 transition-all pointer-events-none z-[100]"></div>
    </div>

    <script>
        // APIã‚­ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¨­å®šï¼‰
        const apiKey = ""; 

        let selectedRate = 0;
        let chartInstance = null;
        let isUserMode = false;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
        let responses = JSON.parse(localStorage.getItem('class_feedback_v2') || '[]');

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'user') {
                isUserMode = true;
                document.getElementById('tabContainer').classList.add('hidden');
            }
            refreshAdminUI();
        };

        function switchTab(tab) {
            if (isUserMode && tab === 'admin') return;
            document.getElementById('view-user').classList.toggle('hidden', tab !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-user').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'user' ? 'active text-blue-600' : 'text-slate-500'}`;
            document.getElementById('tab-admin').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'admin' ? 'active text-blue-600' : 'text-slate-500'}`;
            if (tab === 'admin') updateChart();
        }

        function selectRating(val) {
            selectedRate = val;
            [1, 2, 3].forEach(v => {
                const el = document.getElementById(`rate-${v}`);
                el.className = `rating-card p-4 rounded-xl text-center shadow-sm border-2 ${v === val ? 'border-blue-500 bg-blue-50' : 'border-transparent bg-slate-50'}`;
            });
        }

        function submitResponse() {
            const comment = document.getElementById('userComment').value.trim();
            if (selectedRate === 0) return showMsg("ä»Šã®æ°—æŒã¡ã‚’é¸ã‚“ã§ã­");

            // é€ä¿¡æ™‚åˆ»ã®å–å¾—
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            // ä¿å­˜
            responses.push({ 
                rate: selectedRate, 
                comment: comment || "ç„¡è¨˜å…¥", 
                time: timeStr,
                timestamp: now.getTime()
            });
            localStorage.setItem('class_feedback_v2', JSON.stringify(responses));

            // UIãƒªã‚»ãƒƒãƒˆ
            selectedRate = 0;
            document.getElementById('userComment').value = '';
            [1, 2, 3].forEach(v => document.getElementById(`rate-${v}`).className = "rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm border-2 border-transparent");
            
            showMsg("é€ä¿¡å®Œäº†ï¼");
            refreshAdminUI();
        }

        function refreshAdminUI() {
            document.getElementById('stat-total').textContent = responses.length;
            const list = document.getElementById('commentList');
            const sorted = [...responses].sort((a, b) => b.timestamp - a.timestamp);

            list.innerHTML = sorted.map(r => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-2xl">${r.rate===3?'ğŸ˜Š':r.rate===2?'ğŸ˜':'ğŸ˜•'}</span>
                        <span class="text-[10px] font-bold text-slate-300 bg-slate-50 px-2 py-1 rounded-md">${r.time} é€ä¿¡</span>
                    </div>
                    <p class="text-sm text-slate-600 leading-relaxed font-medium">${r.comment}</p>
                </div>
            `).join('');

            updateChart();
        }

        function updateChart() {
            const canvas = document.getElementById('scoreChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const counts = [0, 0, 0];
            responses.forEach(r => counts[r.rate - 1]++);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ä¸å®‰', 'ã¾ã‚ã¾ã‚', 'ãƒãƒƒãƒãƒª'],
                    datasets: [{ 
                        data: counts, 
                        backgroundColor: ['#f87171', '#fbbf24', '#34d399'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { beginAtZero: true, ticks: { stepSize: 1, color: '#94a3b8' }, grid: { borderDash: [5, 5] } },
                        x: { ticks: { color: '#64748b', font: { weight: 'bold' } }, grid: { display: false } }
                    } 
                }
            });
        }

        async function runAiAnalysis() {
            if (responses.length === 0) return showMsg("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            if (!apiKey) {
                document.getElementById('ai-result').innerHTML = "âš ï¸ APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã® <code>apiKey</code> éƒ¨åˆ†ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚";
                return;
            }

            const btn = document.getElementById('aiBtn');
            const resDiv = document.getElementById('ai-result');
            btn.disabled = true;
            resDiv.innerHTML = "AIãŒæ€è€ƒä¸­...";

            const text = responses.map(r => `è©•ä¾¡:${r.rate}, å†…å®¹:${r.comment}`).join('\n');
            const prompt = `ä»¥ä¸‹ã®æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€100æ–‡å­—ç¨‹åº¦ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\n${text}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                resDiv.innerHTML = result.candidates[0].content.parts[0].text;
            } catch (e) {
                resDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦è©¦ã—ã¦ãã ã•ã„ã€‚";
            } finally {
                btn.disabled = false;
            }
        }

        function clearData() {
            if (confirm("ã™ã¹ã¦ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                responses = [];
                localStorage.removeItem('class_feedback_v2');
                refreshAdminUI();
                showMsg("æ¶ˆå»ã—ã¾ã—ãŸ");
            }
        }

        function showQrModal() {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', 'user');
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: url.toString(), width: 180, height: 180 });
            document.getElementById('qrModal').classList.remove('hidden');
        }

        function hideQrModal() { document.getElementById('qrModal').classList.add('hidden'); }

        function copyStudentUrl() {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', 'user');
            navigator.clipboard.writeText(url.toString());
            showMsg("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function showMsg(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.style.opacity = "1";
            t.style.transform = "translate(-50%, -10px)";
            setTimeout(() => {
                t.style.opacity = "0";
                t.style.transform = "translate(-50%, 0px)";
            }, 3000);
        }
    </script>
</body>
</html>


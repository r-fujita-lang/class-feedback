<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­æŒ¯ã‚Šè¿”ã‚Šãƒ»AIé›†è¨ˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Configuration (Automatically provided by environment)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'reflection-app-v1';

        // Global state
        window.responses = [];
        let currentUser = null;

        // Initialize Anonymous Auth (RULE 3)
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Start listening to data once authenticated
                setupRealtimeListener();
            }
        });

        // Real-time Database Listener (RULE 1 & 2)
        function setupRealtimeListener() {
            if (!currentUser) return;
            const feedbackCol = collection(db, 'artifacts', appId, 'public', 'data', 'feedbacks');
            
            // Fetch all data and filter/sort in JS (RULE 2)
            onSnapshot(feedbackCol, (snapshot) => {
                window.responses = snapshot.docs.map(doc => doc.data());
                // Refresh UI if on admin tab
                if (!document.getElementById('view-admin').classList.contains('hidden')) {
                    window.refreshAdminData();
                }
            }, (error) => {
                console.error("Firestore access error:", error);
            });
        }

        // Global function to save to cloud
        window.submitToCloud = async (rate, comment) => {
            if (!currentUser) {
                alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­ã§ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚");
                return false;
            }
            try {
                const feedbackCol = collection(db, 'artifacts', appId, 'public', 'data', 'feedbacks');
                await addDoc(feedbackCol, {
                    rate: rate,
                    comment: comment,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid
                });
                return true;
            } catch (error) {
                console.error("Failed to save data:", error);
                return false;
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .rating-card { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; }
        .rating-card.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: #3b82f6; }
        .ai-loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-2xl mx-auto p-4 md:p-8">
        
        <!-- Tab Navigation (Hidden in student mode) -->
        <div id="tabContainer" class="flex border-b border-slate-200 mb-8 bg-white rounded-t-xl shadow-sm overflow-hidden">
            <button onclick="switchTab('user')" id="tab-user" class="tab-btn active relative flex-1 py-4 font-bold text-blue-600">å›ç­”ã™ã‚‹</button>
            <button onclick="switchTab('admin')" id="tab-admin" class="tab-btn relative flex-1 py-4 font-bold text-slate-500">ç®¡ç†ç”»é¢</button>
        </div>

        <!-- Student View -->
        <div id="view-user" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mb-6 text-center text-blue-700">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</h2>
                
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div onclick="selectRating(3)" id="rate-3" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ˜Š</div>
                        <div class="text-sm font-bold">ãƒãƒƒãƒãƒª</div>
                    </div>
                    <div onclick="selectRating(2)" id="rate-2" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ˜</div>
                        <div class="text-sm font-bold">ã¾ã‚ã¾ã‚</div>
                    </div>
                    <div onclick="selectRating(1)" id="rate-1" class="rating-card bg-slate-50 p-4 rounded-xl text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ˜•</div>
                        <div class="text-sm font-bold">ä¸å®‰ã‚ã‚Š</div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-600">æ„Ÿæƒ³ã‚„è³ªå•ã‚’æ›¸ã„ã¦ãã ã•ã„</label>
                    <textarea id="userComment" placeholder="ä¾‹ï¼šå…¬å¼ã®æ„å‘³ãŒã‚ˆãã‚ã‹ã£ãŸï¼æ˜æ—¥ã¯ã‚‚ã£ã¨å•é¡Œã‚’è§£ããŸã„ã€‚" 
                        class="w-full h-32 bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-blue-500 transition-all resize-none"></textarea>
                </div>

                <button onclick="submitResponse()" id="submitBtn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                    å…ˆç”Ÿã«é€ä¿¡ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- Admin View -->
        <div id="view-admin" class="hidden space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                    <h3 class="text-xs text-slate-500">ç¾åœ¨ã®å›ç­”æ•°</h3>
                    <p id="stat-total" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <button onclick="showQrModal()" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center hover:bg-slate-50 transition-colors">
                    <span class="text-2xl">ğŸ“±</span>
                    <p class="text-xs font-bold text-slate-600 mt-1">ç”Ÿå¾’ç”¨QR</p>
                </button>
            </div>

            <!-- AI Analysis -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-xl text-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a.997.997 0 00-.12-.47c1.182-.806 1.912-1.934 1.912-3.126 0-1.135-.568-2.203-1.508-3.004a.999.999 0 00-.114.394c0 .59-.47 1.065-1.065 1.065H13.5l-.234.02c.404.267.74.621.986 1.04H14.5l.332.02a2.986 2.986 0 01.168.98c0 .358-.063.702-.178 1.022.68.21 1.258.625 1.678 1.18z"></path></svg>
                        æœ¬æ ¼AIåˆ†æ (Gemini)
                    </h3>
                    <button onclick="runRealAiAnalysis()" id="aiBtn" class="bg-white text-indigo-700 px-4 py-1 rounded-full text-xs font-bold hover:bg-indigo-50 transition-all">
                        åˆ†æã‚’å®Ÿè¡Œ
                    </button>
                </div>
                <div id="ai-result" class="text-sm leading-relaxed bg-black/10 p-4 rounded-xl border border-white/10 min-h-[100px]">
                    ç”Ÿå¾’ã®å£°ã‚’è¦ç´„ã—ã€ã¤ã¾ãšãã‚’ç‰¹å®šã—ã¾ã™ã€‚
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="h-40"><canvas id="scoreChart"></canvas></div>
            </div>

            <!-- Feedback List -->
            <div id="commentList" class="space-y-3"></div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative">
                <button onclick="hideQrModal()" class="absolute top-4 right-4 text-slate-400 p-2 text-xl">âœ•</button>
                <h3 class="text-xl font-bold text-slate-800 mb-2">å›ç­”ç”¨QRã‚³ãƒ¼ãƒ‰</h3>
                <p class="text-xs text-slate-400 mb-6 font-bold">â€»ç”Ÿå¾’ã¯ã“ã®QRã‹ã‚‰å›ç­”å°‚ç”¨ç”»é¢ãŒé–‹ãã¾ã™</p>
                <div id="qrcode" class="flex justify-center mb-6 bg-white p-2 rounded-xl border border-slate-100"></div>
                <button onclick="copyStudentUrl()" class="text-blue-600 text-xs font-bold underline">ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-[100]"></div>
    </div>

    <script>
        const geminiApiKey = ""; // Gemini API Key (Optional for Teacher)
        let selectedRate = 0;
        let chartInstance = null;
        let isUserMode = false;

        // Check mode on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'user') {
                isUserMode = true;
                document.getElementById('tabContainer').classList.add('hidden');
            }
        });

        // Tab switcher
        function switchTab(tab) {
            if (isUserMode && tab === 'admin') return;
            document.getElementById('view-user').classList.toggle('hidden', tab !== 'user');
            document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-user').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'user' ? 'active text-blue-600' : 'text-slate-500'}`;
            document.getElementById('tab-admin').className = `tab-btn relative flex-1 py-4 font-bold ${tab === 'admin' ? 'active text-blue-600' : 'text-slate-500'}`;
            if (tab === 'admin') window.refreshAdminData();
        }

        // Handle rating selection
        function selectRating(val) {
            selectedRate = val;
            [1, 2, 3].forEach(v => {
                document.getElementById(`rate-${v}`).className = `rating-card bg-slate-50 p-4 rounded-xl text-center border-2 ${v === val ? 'border-blue-500 bg-blue-50' : 'border-transparent'}`;
            });
        }

        // Send response to Firestore
        async function submitResponse() {
            const comment = document.getElementById('userComment').value.trim();
            if (selectedRate === 0) return showToast("ä»Šã®æ°—æŒã¡ã‚’é¸ã‚“ã§ã­");
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = "é€ä¿¡ä¸­...";

            const success = await window.submitToCloud(selectedRate, comment || "ç„¡è¨˜å…¥");
            
            if (success) {
                selectedRate = 0;
                document.getElementById('userComment').value = '';
                document.querySelectorAll('.rating-card').forEach(el => el.className = "rating-card bg-slate-50 p-4 rounded-xl text-center border-2 border-transparent shadow-sm");
                showToast("å…ˆç”Ÿã«é€ã£ãŸã‚ˆï¼ã‚ã‚ŠãŒã¨ã†ï¼");
            } else {
                showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            }
            btn.disabled = false;
            btn.textContent = "å…ˆç”Ÿã«é€ä¿¡ã™ã‚‹";
        }

        // Global UI refresh (called by Firestore listener)
        window.refreshAdminData = () => {
            const data = window.responses || [];
            document.getElementById('stat-total').textContent = data.length;
            const list = document.getElementById('commentList');
            
            // Sort by timestamp (newest first)
            const sortedData = [...data].sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            list.innerHTML = sortedData.map(r => `
                <div class="bg-white p-3 rounded-xl border border-slate-200 flex gap-3 text-sm shadow-sm">
                    <span class="text-xl">${r.rate===3?'ğŸ˜Š':r.rate===2?'ğŸ˜':'ğŸ˜•'}</span>
                    <div><p class="text-slate-700 font-medium">${r.comment}</p></div>
                </div>
            `).slice(0, 50).join('');
            
            updateChart(data);
        };

        // Draw Chart.js
        function updateChart(data) {
            const counts = [0, 0, 0];
            data.forEach(r => counts[r.rate - 1]++);
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ğŸ˜•', 'ğŸ˜', 'ğŸ˜Š'],
                    datasets: [{ data: counts, backgroundColor: ['#f87171', '#fbbf24', '#34d399'], borderRadius: 8 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        // AI Analysis using Gemini
        async function runRealAiAnalysis() {
            const data = window.responses || [];
            if (data.length === 0) return showToast("å›ç­”ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“");
            const btn = document.getElementById('aiBtn');
            const resultDiv = document.getElementById('ai-result');
            btn.disabled = true;
            btn.textContent = "AIåˆ†æä¸­...";
            resultDiv.innerHTML = '<div class="ai-loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

            const commentList = data.map(r => `ã€è©•ä¾¡:${r.rate}ã€‘ ${r.comment}`).join('\n');
            const prompt = `ã‚ãªãŸã¯æ•™å¸«ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€1.å…¨ä½“ã®æ§˜å­ã€2.ç›®ç«‹ã¤ã¤ã¾ãšãã€3.æ˜æ—¥ã¸ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç°¡æ½”ã«å ±å‘Šã—ã¦ãã ã•ã„ã€‚å›ç­”ã¯æ—¥æœ¬èªã§ãŠé¡˜ã„ã—ã¾ã™ã€‚\n\n${commentList}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                resultDiv.innerHTML = (result.candidates?.[0]?.content?.parts?.[0]?.text || "åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚").replace(/\n/g, '<br>');
            } catch (e) { 
                resultDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; 
            }
            btn.disabled = false;
            btn.textContent = "åˆ†æã‚’æ›´æ–°";
        }

        // QR and URL helpers
        function getStudentUrl() {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', 'user');
            return url.toString();
        }

        function showQrModal() {
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { 
                text: getStudentUrl(), 
                width: 200, 
                height: 200,
                correctLevel : QRCode.CorrectLevel.H
            });
            document.getElementById('qrModal').classList.remove('hidden');
        }

        function hideQrModal() { document.getElementById('qrModal').classList.add('hidden'); }

        function copyStudentUrl() {
            const url = getStudentUrl();
            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("ç”Ÿå¾’ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-100 transform translate-y-0 z-[100]";
            setTimeout(() => t.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-0 transform translate-y-4", 3000);
        }
    </script>
</body>
</html>

